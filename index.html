<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Whatsapp Opener</title>
  <meta name="color-scheme" content="light dark" />
  <meta name="theme-color" content="#16a34a">
  <link rel="manifest" href="./manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="./icons/icon-180.png">
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#94a3b8;
      --primary:#16a34a; --primary-2:#22c55e; --danger:#ef4444; --ring:#22c55e33;
      --shadow:0 10px 30px rgba(0,0,0,.35); --radius:18px;
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f6f7fb; --card:#fff; --text:#0f172a; --muted:#64748b; --shadow:0 12px 28px rgba(15,23,42,.08) }
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:24px; min-height:100dvh; display:grid; place-items:center;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      background: radial-gradient(1200px 600px at 80% -10%, #22c55e22, transparent 60%), var(--bg);
      color:var(--text);
    }
    .wrap{ width:min(640px,100%) }
    .card{ background:var(--card); border-radius:var(--radius); padding:22px; box-shadow:var(--shadow); border:1px solid #ffffff12 }
    .title{ display:flex; align-items:center; gap:10px; font-weight:700; font-size:1.25rem; margin:0 0 6px }
    .subtitle{ color:var(--muted); margin:0 0 18px; font-size:.95rem }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .field{
      display:flex; gap:10px; align-items:center; margin:10px 0 14px;
      background:#ffffff08; border:1px solid #ffffff14; border-radius:14px; padding:8px 10px;
      transition:box-shadow .2s,border-color .2s,background .2s;
      flex:1 1 auto;
    }
    .field:focus-within{ border-color:var(--primary-2); box-shadow:0 0 0 4px var(--ring); background:#ffffff0f }
    .select{
      display:flex; align-items:center; gap:8px; background:#22c55e22; border:1px solid #22c55e44;
      border-radius:12px; padding:6px 8px; color:#d1fae5; flex:0 0 240px;
    }
    .select select{
      background:transparent; border:none; outline:none; color:inherit; font-weight:700; width:100%;
      direction:ltr;
    }
    input[type="tel"]{ flex:1; min-width:200px; border:none; outline:none; background:transparent; color:var(--text); padding:.6rem; font-size:1.05rem; caret-color:var(--primary-2) }
    input::placeholder{ color:#94a3b880 }
    .actions{ display:flex; flex-wrap:wrap; gap:10px; margin-top:6px }
    .btn{
      appearance:none; border:none; outline:none; cursor:pointer; border-radius:14px; padding:12px 14px;
      font-weight:700; font-size:1rem; background:linear-gradient(180deg,var(--primary-2),var(--primary)); color:#fff;
      box-shadow:0 10px 22px rgba(34,197,94,.25); transition:transform .08s,filter .2s;
    }
    .btn:active{ transform:translateY(1px); filter:saturate(1.05) }
    .btn.secondary{ background:#ffffff10; color:var(--text); border:1px solid #ffffff1a; box-shadow:none }
    .btn.ghost{ background:#ffffff06; color:var(--text); border:1px solid #ffffff12 }
    .btn.small{ padding:10px 12px; font-size:.95rem }
    .preview{
      margin-top:14px; background:#ffffff05; border:1px dashed #ffffff2a; border-radius:12px; padding:12px;
      font-family:ui-monospace,Menlo,Consolas,monospace; font-size:.9rem; color:#a7f3d0; overflow:auto; white-space:nowrap;
    }
    .muted{ color:var(--muted); font-size:.88rem; margin-top:8px }
    .toast{
      position:fixed; inset-inline:0; bottom:18px; width:min(420px,calc(100% - 36px)); margin-inline:auto;
      padding:12px 14px; border-radius:12px; text-align:center; font-weight:600; background:#000c; color:#fff; backdrop-filter:blur(6px);
      transform:translateY(20px); opacity:0; pointer-events:none; transition:all .25s ease;
    }
    .toast.show{ transform:translateY(0); opacity:1 }
    .toast.danger{ background:#ef4444e6 }
    .hint{ display:none; margin-top:10px; padding:10px; border-radius:12px; border:1px dashed #ffffff2a; background:#ffffff08; color:var(--text); font-size:.9rem; }
    .hint.show{ display:block }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 class="title">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 2a10 10 0 0 0-8.66 14.9L2 22l5.2-1.32A10 10 0 1 0 12 2Z" stroke="#22c55e" stroke-width="1.6"/>
          <path d="M8.5 9.2c0 4.2 3.3 6.9 7.3 7.3.3 0 .6-.1.8-.3l1.2-1.2a.8.8 0 0 0-.1-1.2l-1.6-1.1a.8.8 0 0 0-1 0l-.7.5a.8.8 0 0 1-.8.1 6.4 6.4 0 0 1-2.9-2.9.8.8 0 0 1 .1-.8l.5-.7a.8.8 0 0 0 0-1L10 6.7a.8.8 0 0 0-1.2-.1L7.6 7.9c-.2.2-.3.5-.3.8Z" fill="#22c55e"/>
        </svg>
        Whatsapp Opener — افتح محادثة واتساب برقم
      </h1>

      <p class="subtitle">اختر مفتاح الدولة ثم أدخل الرقم. سيضيف التطبيق الكود تلقائيًا بدون حذف الصفر الأول.</p>

      <div class="row">
        <div class="select">
          <span>📞</span>
          <select id="country">
            <option value="20" selected>🇪🇬 مصر (+20)</option>
            <option value="966">🇸🇦 السعودية (+966)</option>
            <option disabled>──────────</option>
            <option value="971">🇦🇪 الإمارات (+971)</option>
            <option value="965">🇰🇼 الكويت (+965)</option>
            <option value="973">🇧🇭 البحرين (+973)</option>
            <option value="974">🇶🇦 قطر (+974)</option>
            <option value="968">🇴🇲 عمان (+968)</option>
            <option value="962">🇯🇴 الأردن (+962)</option>
            <option value="961">🇱🇧 لبنان (+961)</option>
            <option value="963">🇸🇾 سوريا (+963)</option>
            <option value="964">🇮🇶 العراق (+964)</option>
            <option value="212">🇲🇦 المغرب (+212)</option>
            <option value="213">🇩🇿 الجزائر (+213)</option>
            <option value="216">🇹🇳 تونس (+216)</option>
            <option value="249">🇸🇩 السودان (+249)</option>
            <option value="967">🇾🇪 اليمن (+967)</option>
            <option value="222">🇲🇷 موريتانيا (+222)</option>
            <option disabled>──────────</option>
            <option value="90">🇹🇷 تركيا (+90)</option>
            <option value="1">🇺🇸 أمريكا (+1)</option>
            <option value="44">🇬🇧 بريطانيا (+44)</option>
            <option value="33">🇫🇷 فرنسا (+33)</option>
            <option value="49">🇩🇪 ألمانيا (+49)</option>
            <option value="39">🇮🇹 إيطاليا (+39)</option>
            <option value="34">🇪🇸 إسبانيا (+34)</option>
            <option value="91">🇮🇳 الهند (+91)</option>
          </select>
        </div>

        <div class="field" style="flex:1 1 280px;">
          <input id="phone" type="tel" inputmode="tel" autocomplete="tel-national" placeholder="012xxxxxxxx/011xxxxxxxx/010xxxxxxxx" />
        </div>
      </div>

      <div class="actions">
        <button class="btn" id="openBtn">افتح واتساب الآن</button>
        <button class="btn secondary" id="copyBtn" title="نسخ الرابط">نسخ الرابط</button>
        <button class="btn ghost small" id="installBtn" style="display:none">أضف إلى الشاشة الرئيسية</button>
      </div>

      <div class="preview" id="preview">https://api.whatsapp.com/send?phone=2</div>

      <p class="muted">تلميح: يمكنك اضافة الاداة الى الشاشة الرئيسية لهاتفك من خلال زرار &#8942; الموجود بالمتصفح</p>
      <div class="hint" id="iosHint">
        على iPhone/iPad: افتح الموقع في <b>Safari</b>، ثم اضغط زر <b>المشاركة</b> (المربع مع السهم ↑)، وبعدها اختر <b>Add to Home Screen</b>.
      </div>

      <p class="muted">تلميح إضافي: اضغط Enter داخل الحقل لفتح واتساب. سيتم تجربة التطبيق أولاً ثم الصفحة كخطة بديلة.</p>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ---------------- Core app logic ----------------
    const country = document.getElementById('country');
    const input  = document.getElementById('phone');
    const openBtn = document.getElementById('openBtn');
    const copyBtn = document.getElementById('copyBtn');
    const preview = document.getElementById('preview');
    const toastEl = document.getElementById('toast');

    function showToast(msg, kind){
      toastEl.textContent = msg;
      toastEl.className = 'toast' + (kind ? ' ' + kind : '');
      requestAnimationFrame(()=> toastEl.classList.add('show'));
      setTimeout(()=> toastEl.classList.remove('show'), 2000);
    }

    function buildNumber(){
      const code = country.value; // بدون +
      let digits = (input.value || '').replace(/\D+/g, '');
      if (!digits) return null;
      return code + digits; // نحافظ على الصفر الأول داخل الرقم
    }

    function buildUrls(){
      const full = buildNumber();
      if (!full) return { apiUrl: null, intentUrl: null };
      const apiUrl = 'https://api.whatsapp.com/send?phone=' + encodeURIComponent(full);
      const intentUrl = 'whatsapp://send?phone=' + encodeURIComponent(full);
      return { apiUrl, intentUrl };
    }

    function updatePreview(){
      const { apiUrl } = buildUrls();
      preview.textContent = apiUrl || 'https://api.whatsapp.com/send?phone=2';
    }

    function openWhatsApp(){
      const { apiUrl, intentUrl } = buildUrls();
      if (!apiUrl || !intentUrl) { showToast('ادخل رقم صحيح', 'danger'); return; }
      window.location.href = intentUrl;
      setTimeout(() => window.location.href = apiUrl, 700);
    }

    async function copyLink(){
      const { apiUrl } = buildUrls();
      if (!apiUrl) { showToast('لا يوجد رابط لنسخه', 'danger'); return; }
      try{ await navigator.clipboard.writeText(apiUrl); showToast('تم نسخ الرابط'); }
      catch{
        const ta = document.createElement('textarea'); ta.value = apiUrl; document.body.appendChild(ta);
        ta.select(); document.execCommand('copy'); document.body.removeChild(ta); showToast('تم نسخ الرابط');
      }
    }

    input.addEventListener('input', updatePreview);
    country.addEventListener('change', updatePreview);
    input.addEventListener('keydown', (e) => { if (e.key === 'Enter') openWhatsApp(); });
    openBtn.addEventListener('click', openWhatsApp);
    copyBtn.addEventListener('click', copyLink);
    window.addEventListener('load', () => input.focus({ preventScroll:true }));
    updatePreview();

    // ---------------- PWA install button logic ----------------
    const installBtn = document.getElementById('installBtn');
    const iosHint = document.getElementById('iosHint');
    let deferredPrompt = null;

    function isStandalone(){
      return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
    }
    function isIosSafari(){
      const ua = window.navigator.userAgent.toLowerCase();
      const isiOS = /iphone|ipad|ipod/.test(ua);
      const isSafari = /^((?!crios|fxios|edgios).)*safari/.test(window.navigator.userAgent.toLowerCase());
      return isiOS && isSafari;
    }

    window.addEventListener('beforeinstallprompt', (e) => {
      if (isStandalone()) return;
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'inline-block';
      installBtn.textContent = 'أضف إلى الشاشة الرئيسية';
      installBtn.onclick = async () => {
        try{
          deferredPrompt.prompt();
          const choice = await deferredPrompt.userChoice;
          if (choice.outcome === 'accepted') showToast('تم بدء التثبيت');
          deferredPrompt = null;
          installBtn.style.display = 'none';
        }catch(_){}
      };
    });

    function setupIosA2HS(){
      if (isStandalone()) return;
      if (isIosSafari()){
        installBtn.style.display = 'inline-block';
        installBtn.textContent = 'أضف إلى الشاشة الرئيسية';
        installBtn.onclick = () => {
          iosHint.classList.toggle('show');
          showToast('افتح قائمة المشاركة ثم Add to Home Screen');
        };
      } else {
        const isiOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
        if (isiOS){
          installBtn.style.display = 'inline-block';
          installBtn.textContent = 'افتح في Safari للإضافة';
          installBtn.onclick = () => showToast('افتح الرابط في Safari ثم استخدم Add to Home Screen');
        }
      }
    }
    setupIosA2HS();

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(console.error);
      });
    }
  </script>
</body>
</html>
